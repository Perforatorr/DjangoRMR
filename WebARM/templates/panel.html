{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления</title>
    <link rel="stylesheet" href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/Roboto.css' %}">
    <style>
        .machine-card {
            width: 300px;
            height: 200px;
            border: 4px solid;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px; /* Уменьшили отступы */
            transition: all 0.3s ease;
            background-color: white;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .machine-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px;
        }
        .machine-card:active {
            transform: translateY(2px);
        }
        .machine-name {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            z-index: 2;
        }
        .status-0 { 
            border-color: rgb(1, 174, 84); /* Зеленый */
            background-color: rgb(255, 255, 255);
        }
        .status-other { 
            border-color: rgb(227, 20, 62); /* Красный */
            background-color: rgb(255, 255, 255);
        }
        .navbar-logo { height: 50px; }
        .user-info { display: flex; align-items: center; }
        .user-name { margin-right: 15px; }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px; /* Уменьшили промежуток */
            padding: 15px; /* Уменьшили отступы */
        }
        .status-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .status-0 .status-indicator {
            background-color: rgb(1, 174, 84);
        }
        .status-other .status-indicator {
            background-color: rgb(227, 20, 62);
        }

        /* Адаптивные стили */
        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 10px;
                padding: 10px;
            }
            .machine-card {
                width: 100%;
                max-width: 280px;
                height: 180px;
                margin: 5px auto; /* Центрируем на мобильных */
            }
        }
        
        @media (max-width: 576px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            .machine-card {
                max-width: none;
                height: 160px;
            }
            .navbar-brand {
                margin-right: 10px;
            }
            .user-info {
                flex-direction: column;
                align-items: flex-end;
            }
            .user-name {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body style="font-family: Roboto, sans-serif; background: rgb(238,239,241);">
    <!-- Шапка -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'panel' %}">
                <img src="{% static 'assets/img/logo.svg' %}" alt="Логотип" class="navbar-logo">
            </a>
            
            <div class="user-info">
                <span class="user-name">{{ request.session.user_name }}</span>
                <a href=/logout class="btn btn-outline-danger btn-sm">Выйти</a>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <div class="container mt-3"> <!-- Уменьшили верхний отступ --> <!-- Уменьшили нижний отступ -->
        
        <div class="grid-container">
            {% for machine in machines %}
            <div class="machine-card {% if machine.condition.id == 0 %}status-0{% else %}status-other{% endif %}"
                 onclick="handleMachineClick('{{ machine.id }}')">
                <div class="machine-name">{{ machine.name }}</div>
                <div class="status-indicator"></div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="{% static 'assets/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script>
        function handleMachineClick(machineId) {
            // Здесь будет логика обработки клика по станку
            console.log("Выбран станок:", machineId);
            
            // Пример: переход на страницу детализации станка
            window.location.href = `machine/${machineId}/change_condition/`;
            
            // Или открытие модального окна с деталями
            // openMachineDetails(machineId);
        }
        
        // Для демонстрации - показываем alert при клике
        document.querySelectorAll('.machine-card').forEach(card => {
            card.addEventListener('click', function() {
                const machineName = this.querySelector('.machine-name').textContent;
                alert(`Вы выбрали: ${machineName}\nID: ${this.onclick.toString().match(/'([^']+)'/)[1]}`);
            });
        });
        let idleTime = 20 * 1000; // 20 секунд
        let lastActivity = new Date().getTime();

        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Если этот конкретный cookie начинается с имени, которое вы ищете
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrfToken = getCookie('csrftoken');

        function logoutUser() {
        // Создаем скрытую форму для отправки POST-запроса
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/logout/';  // Указываем абсолютный URL

        // CSRF токен
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        // Добавляем форму в DOM и отправляем
        document.body.appendChild(form);
        form.submit();
    }

    function idleCheck() {
        let currentTime = new Date().getTime();
        if (currentTime - lastActivity > idleTime) {
            logoutUser();  // Используем новую функцию для выхода
        } else {
            lastActivity = currentTime;
        }
    }

        document.addEventListener('mousemove', idleCheck);
        document.addEventListener('keypress', idleCheck);

    </script>
</body>
</html>